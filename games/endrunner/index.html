<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Endless Runner Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, #6a11cb, #ffffff);
      font-family: 'Arial', sans-serif;
      color: #333;
    }
    canvas {
      display: block;
    }
    .ui-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .button {
      pointer-events: auto;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      color: #ffffff;
      transition: transform 0.2s, background-color 0.2s;
    }
    .button:hover {
      transform: scale(1.05);
    }
    .primary-button {
      background-color: #3498db;
    }
    .secondary-button {
      background-color: #6a11cb;
    }
    .mobile-controls {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      box-sizing: border-box;
    }
    .mobile-button {
      pointer-events: auto;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      color: #ffffff;
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      touch-action: none;
    }
    .modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      text-align: center;
      max-width: 80%;
      pointer-events: auto;
    }
    .modal h2 {
      margin: 0 0 20px;
      font-size: 24px;
      color: #333;
    }
    .loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: auto;
    }
    .spinner {
      border: 4px solid #ffffff;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .score {
      position: absolute;
      top: 20px;
      left: 20px;
      color: #ffffff;
      font-size: 20px;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }
    @media (min-width: 768px) {
      .mobile-controls {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="ui-container">
    <div class="score" id="score">Score: 0</div>
    <div class="mobile-controls" id="mobileControls">
      <div class="mobile-button" id="leftButton">←</div>
      <div class="mobile-button" id="jumpButton">↑</div>
      <div class="mobile-button" id="rightButton">→</div>
    </div>
    <div class="modal" id="startModal">
      <h2>Endless Runner</h2>
      <p>Desktop: Use arrow keys to move and jump.<br>Mobile: Use buttons or tilt device to move, tap jump button.</p>
      <button class="button primary-button" id="startButton">Start Game</button>
      <button class="button secondary-button" id="toggleTilt">Enable Tilt Controls</button>
    </div>
    <div class="modal" id="gameOverModal" style="display: none;">
      <h2>Game Over</h2>
      <p>Your Score: <span id="finalScore">0</span></p>
      <button class="button primary-button" id="restartButton">Restart</button>
    </div>
    <div class="loader" id="loader" style="display: none;">
      <div class="spinner"></div>
    </div>
  </div>
  <script>
    let player, obstacles, powerUps, ground, score, gameState, speed, tiltEnabled;
    let isMobile = /Mobi|Android/i.test(navigator.userAgent);
    let leftPressed = false, rightPressed = false, jumpPressed = false;
    let lastTouch = { left: false, right: false, jump: false };

    function setup() {
      createCanvas(800, 400);
      resetGame();
      document.getElementById('startButton').addEventListener('click', startGame);
      document.getElementById('restartButton').addEventListener('click', resetGame);
      document.getElementById('toggleTilt').addEventListener('click', toggleTiltControls);
      if (isMobile) {
        setupMobileControls();
        if (window.DeviceOrientationEvent) {
          document.getElementById('toggleTilt').style.display = 'block';
        }
      }
    }

    function resetGame() {
      player = { x: 100, y: 350, vy: 0, width: 40, height: 40, jumping: false };
      obstacles = [];
      powerUps = [];
      ground = 350;
      score = 0;
      speed = 5;
      gameState = 'start';
      tiltEnabled = false;
      document.getElementById('score').innerText = 'Score: 0';
      document.getElementById('startModal').style.display = 'block';
      document.getElementById('gameOverModal').style.display = 'none';
      document.getElementById('loader').style.display = 'none';
    }

    function startGame() {
      gameState = 'playing';
      document.getElementById('startModal').style.display = 'none';
      document.getElementById('loader').style.display = 'block';
      setTimeout(() => {
        document.getElementById('loader').style.display = 'none';
      }, 1000);
      loop();
    }

    function toggleTiltControls() {
      tiltEnabled = !tiltEnabled;
      document.getElementById('toggleTilt').innerText = tiltEnabled ? 'Disable Tilt Controls' : 'Enable Tilt Controls';
      if (tiltEnabled) {
        window.addEventListener('deviceorientation', handleOrientation);
      } else {
        window.removeEventListener('deviceorientation', handleOrientation);
      }
    }

    function handleOrientation(event) {
      if (!tiltEnabled) return;
      let tilt = event.gamma; // Left-right tilt (-90 to 90)
      player.x += map(tilt, -30, 30, -5, 5);
      player.x = constrain(player.x, 0, width - player.width);
    }

    function setupMobileControls() {
      let leftButton = document.getElementById('leftButton');
      let rightButton = document.getElementById('rightButton');
      let jumpButton = document.getElementById('jumpButton');

      function handleTouchStart(e, button) {
        e.preventDefault();
        lastTouch[button] = true;
        if (button === 'left') leftPressed = true;
        if (button === 'right') rightPressed = true;
        if (button === 'jump') jumpPressed = true;
      }

      function handleTouchEnd(e, button) {
        e.preventDefault();
        lastTouch[button] = false;
        if (button === 'left') leftPressed = false;
        if (button === 'right') rightPressed = false;
        if (button === 'jump') jumpPressed = false;
      }

      leftButton.addEventListener('touchstart', (e) => handleTouchStart(e, 'left'));
      rightButton.addEventListener('touchstart', (e) => handleTouchStart(e, 'right'));
      jumpButton.addEventListener('touchstart', (e) => handleTouchStart(e, 'jump'));
      leftButton.addEventListener('touchend', (e) => handleTouchEnd(e, 'left'));
      rightButton.addEventListener('touchend', (e) => handleTouchEnd(e, 'right'));
      jumpButton.addEventListener('touchend', (e) => handleTouchEnd(e, 'jump'));
    }

    function keyPressed() {
      if (keyCode === UP_ARROW && !player.jumping) {
        player.vy = -15;
        player.jumping = true;
      }
    }

    function keyReleased() {
      if (keyCode === LEFT_ARROW) leftPressed = false;
      if (keyCode === RIGHT_ARROW) rightPressed = false;
    }

    function draw() {
      if (gameState !== 'playing') {
        noLoop();
        return;
      }

      background(255);
      fill(0);
      line(0, ground, width, ground);

      // Update player
      if (isMobile && !tiltEnabled) {
        if (leftPressed) player.x -= 5;
        if (rightPressed) player.x += 5;
        if (jumpPressed && !player.jumping) {
          player.vy = -15;
          player.jumping = true;
        }
      } else if (!isMobile) {
        if (keyIsDown(LEFT_ARROW)) player.x -= 5;
        if (keyIsDown(RIGHT_ARROW)) player.x += 5;
      }
      player.x = constrain(player.x, 0, width - player.width);

      // Apply gravity
      player.vy += 0.5;
      player.y += player.vy;
      if (player.y >= ground) {
        player.y = ground;
        player.vy = 0;
        player.jumping = false;
      }
      fill(0, 255, 0);
      rect(player.x, player.y - player.height, player.width, player.height);

      // Spawn obstacles
      if (frameCount % 60 === 0) {
        obstacles.push({ x: width, y: ground, width: 30, height: random(20, 60) });
      }

      // Spawn power-ups
      if (frameCount % 180 === 0 && random() < 0.3) {
        powerUps.push({ x: width, y: ground - 50, width: 20, height: 20, type: 'speed' });
      }

      // Update obstacles
      for (let i = obstacles.length - 1; i >= 0; i--) {
        obstacles[i].x -= speed;
        fill(255, 0, 0);
        rect(obstacles[i].x, ground - obstacles[i].height, obstacles[i].width, obstacles[i].height);
        if (obstacles[i].x < -obstacles[i].width) {
          obstacles.splice(i, 1);
          score += 10;
        } else if (collideRectRect(player.x, player.y - player.height, player.width, player.height, obstacles[i].x, ground - obstacles[i].height, obstacles[i].width, obstacles[i].height)) {
          gameState = 'gameOver';
          document.getElementById('finalScore').innerText = score;
          document.getElementById('gameOverModal').style.display = 'block';
          noLoop();
        }
      }

      // Update power-ups
      for (let i = powerUps.length - 1; i >= 0; i--) {
        powerUps[i].x -= speed;
        fill(0, 0, 255);
        ellipse(powerUps[i].x + powerUps[i].width / 2, powerUps[i].y + powerUps[i].height / 2, powerUps[i].width, powerUps[i].height);
        if (powerUps[i].x < -powerUps[i].width) {
          powerUps.splice(i, 1);
        } else if (collideRectCircle(player.x, player.y - player.height, player.width, player.height, powerUps[i].x + powerUps[i].width / 2, powerUps[i].y + powerUps[i].height / 2, powerUps[i].width)) {
          if (powerUps[i].type === 'speed') {
            speed += 2;
            setTimeout(() => speed = max(5, speed - 2), 5000);
          }
          powerUps.splice(i, 1);
          score += 50;
        }
      }

      // Increase speed over time
      if (frameCount % 600 === 0) {
        speed += 0.5;
      }

      // Update score
      score += 0.1;
      document.getElementById('score').innerText = `Score: ${floor(score)}`;
    }

    function collideRectRect(x1, y1, w1, h1, x2, y2, w2, h2) {
      return x1 < x2 + w2 && x1 + w1 > x2 && y1 < y2 + h2 && y1 + h1 > y2;
    }

    function collideRectCircle(rx, ry, rw, rh, cx, cy, diameter) {
      let testX = cx;
      let testY = cy;
      if (cx < rx) testX = rx;
      else if (cx > rx + rw) testX = rx + rw;
      if (cy < ry) testY = ry;
      else if (cy > ry + rh) testY = ry + rh;
      let distX = cx - testX;
      let distY = cy - testY;
      let distance = sqrt(distX * distX + distY * distY);
      return distance <= diameter / 2;
    }
  </script>
</body>
</html>